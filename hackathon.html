<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#667eea" />
    <title>Banking APK Security Analyzer • Improved</title>
    <!-- TailwindCSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <!-- JSZip -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js" defer></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card-shadow {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .upload-area {
            transition: transform .2s ease, box-shadow .2s ease;
        }

        .upload-area:hover {
            transform: translateY(-2px);
        }

        .chart-container {
            height: 300px;
        }

        .detailed-chart {
            height: 420px;
        }

        .kbd {
            @apply inline-flex items-center px-2 py-0.5 rounded bg-gray-100 border text-xs font-mono;
        }

        @media (prefers-reduced-motion: reduce) {

            .animate-spin,
            .transition,
            .upload-area {
                transition: none !important;
                animation: none !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 font-sans antialiased text-gray-800">
    <!-- Toasts -->
    <div id="toastRoot" class="fixed inset-x-0 top-4 z-50 flex flex-col items-center space-y-2 pointer-events-none">
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-shield-alt text-3xl" aria-hidden="true"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Banking APK Security Analyzer</h1>
                        <p class="text-sm opacity-90">AI‑assisted static heuristics (demo)</p>
                    </div>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="text-right" aria-label="Detection Accuracy">
                        <div class="text-sm opacity-90">Detection Accuracy</div>
                        <div class="text-xl font-bold">99.1%</div>
                    </div>
                    <div class="text-right" aria-live="polite">
                        <div class="text-sm opacity-90">Scanned (local)</div>
                        <div class="text-xl font-bold" id="scannedCount">0</div>
                    </div>
                    <button id="themeToggle" type="button"
                        class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg focus:outline-none focus:ring-2 focus:ring-white"
                        aria-pressed="false" title="Toggle dark mode">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto px-4 py-8">
        <!-- Upload Section -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-lg p-8" id="uploadCard">
                <h2 class="text-2xl font-bold mb-6 flex items-center text-gray-900">
                    <i class="fas fa-upload text-blue-600 mr-2" aria-hidden="true"></i>
                    APK Analysis Center
                </h2>

                <div class="grid md:grid-cols-2 gap-6" role="group" aria-label="Upload options">
                    <!-- Single File Upload -->
                    <div id="singleUpload"
                        class="upload-area bg-blue-50 border-2 border-dashed border-blue-300 rounded-lg p-8 text-center cursor-pointer focus-within:ring-2 ring-blue-400"
                        tabindex="0" role="button" aria-label="Single APK Analysis">
                        <i class="fas fa-file-upload text-4xl text-blue-500 mb-4" aria-hidden="true"></i>
                        <h3 class="text-lg font-semibold mb-2">Single APK Analysis</h3>
                        <p class="text-gray-600 mb-4">Drag & drop an APK file or click to browse</p>
                        <input type="file" id="singleFileInput" accept=".apk,application/vnd.android.package-archive"
                            class="hidden" />
                        <button type="button"
                            class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-400">
                            Select APK File <span class="ml-2 text-xs text-white/80">(or drop)</span>
                        </button>
                        <div class="mt-3 text-xs text-gray-500">Tip: Press <span class="kbd">Enter</span> to open the
                            picker.</div>
                    </div>

                    <!-- Batch Upload -->
                    <div id="batchUpload"
                        class="upload-area bg-green-50 border-2 border-dashed border-green-300 rounded-lg p-8 text-center cursor-pointer focus-within:ring-2 ring-green-400"
                        tabindex="0" role="button" aria-label="Batch Processing">
                        <i class="fas fa-layer-group text-4xl text-green-500 mb-4" aria-hidden="true"></i>
                        <h3 class="text-lg font-semibold mb-2">Batch Processing</h3>
                        <p class="text-gray-600 mb-4">Upload multiple APK files for analysis</p>
                        <input type="file" id="batchFileInput" accept=".apk,application/vnd.android.package-archive"
                            multiple class="hidden" />
                        <button type="button"
                            class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:ring-2 focus:ring-green-400">
                            Select Multiple APKs
                        </button>
                    </div>
                </div>

                <!-- Analysis Options -->
                <div class="mt-6 bg-gray-50 rounded-lg p-4">
                    <h4 class="font-semibold mb-3">Analysis Mode</h4>
                    <fieldset class="flex flex-wrap gap-x-6 gap-y-2" id="modeFieldset">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="analysisMode" value="quick" class="mr-2" checked />
                            <span>Quick Scan (~0.1s) — 93.97% accuracy</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="analysisMode" value="balanced" class="mr-2" />
                            <span>Balanced (~0.1–0.2s) — 94.01% accuracy</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="analysisMode" value="deep" class="mr-2" />
                            <span>Deep (~3–5s) — 99.1% accuracy</span>
                        </label>
                    </fieldset>
                    <div class="mt-3 text-xs text-gray-500">Note: This demo performs a simulated static analysis. No
                        files are uploaded.
                    </div>
                </div>
            </div>
        </section>

        <!-- Progress Section -->
        <section id="progressSection" class="mb-8 hidden" aria-live="polite">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold flex items-center">
                        <i class="fas fa-cog fa-spin text-blue-600 mr-2" aria-hidden="true"></i>
                        Analysis in Progress
                    </h3>
                    <button id="cancelBtn" type="button"
                        class="px-3 py-1.5 text-sm rounded bg-red-600 text-white hover:bg-red-700">Cancel</button>
                </div>
                <div class="space-y-4">
                    <div class="bg-gray-200 rounded-full h-2" aria-label="Overall progress">
                        <div id="overallProgress" class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            style="width:0%"></div>
                    </div>
                    <ol id="stagesList" class="space-y-2 list-decimal ml-5"></ol>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section id="resultsSection" class="mb-8 hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex flex-wrap gap-3 justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-chart-line text-green-600 mr-2" aria-hidden="true"></i>
                        Analysis Results
                    </h3>
                    <div class="flex gap-2">
                        <button id="exportBtn" type="button"
                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-file-zipper mr-2" aria-hidden="true"></i>Export ZIP Report
                        </button>
                        <button id="resetBtn" type="button"
                            class="bg-gray-100 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-200">
                            <i class="fas fa-rotate mr-2" aria-hidden="true"></i>Reset
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="grid sm:grid-cols-2 md:grid-cols-4 gap-6 mb-8" id="summaryGrid">
                    <div id="threatCard" class="text-white p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Threat Level</p>
                                <p id="threatLevel" class="text-2xl font-bold">LOW</p>
                            </div>
                            <i class="fas fa-exclamation-triangle text-3xl opacity-80" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Malware Probability</p>
                                <p id="malwareProbability" class="text-2xl font-bold">0%</p>
                            </div>
                            <i class="fas fa-percentage text-3xl opacity-80" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 text-white p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Security Score</p>
                                <p id="securityScore" class="text-2xl font-bold">95/100</p>
                            </div>
                            <i class="fas fa-shield-alt text-3xl opacity-80" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-6 rounded-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-white/80 text-sm">Analysis Time</p>
                                <p id="analysisTime" class="text-2xl font-bold">0ms</p>
                            </div>
                            <i class="fas fa-clock text-3xl opacity-80" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>

                <!-- File meta -->
                <div id="fileMeta" class="mb-6 hidden text-sm text-gray-600"></div>

                <!-- Charts -->
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Model Confidence Scores</h4>
                        <div class="chart-container"><canvas id="modelScoresChart"></canvas></div>
                    </div>
                    <div class="bg-gray-50 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Security Analysis Breakdown</h4>
                        <div class="chart-container"><canvas id="securityBreakdownChart"></canvas></div>
                    </div>
                </div>

                <!-- Detailed Analysis -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <h4 class="text-lg font-semibold mb-4">Detailed Security Analysis</h4>
                    <div class="detailed-chart"><canvas id="permissionAnalysisChart"></canvas></div>
                </div>

                <!-- Findings -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-red-50 border border-red-200 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold text-red-800 mb-3">
                            <i class="fas fa-exclamation-triangle mr-2" aria-hidden="true"></i>Security Issues
                        </h4>
                        <ul id="securityIssues" class="space-y-2 text-red-700"></ul>
                    </div>
                    <div class="bg-green-50 border border-green-200 p-6 rounded-lg">
                        <h4 class="text-lg font-semibold text-green-800 mb-3">
                            <i class="fas fa-check-circle mr-2" aria-hidden="true"></i>Security Features
                        </h4>
                        <ul id="securityFeatures" class="space-y-2 text-green-700"></ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- History -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-history text-gray-600 mr-2" aria-hidden="true"></i>
                    Recent Scan History
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left">File Name</th>
                                <th class="px-4 py-3 text-left">SHA-256</th>
                                <th class="px-4 py-3 text-left">Scan Time</th>
                                <th class="px-4 py-3 text-left">Threat Level</th>
                                <th class="px-4 py-3 text-left">Malware %</th>
                                <th class="px-4 py-3 text-left">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- About -->
        <section class="mb-8">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <i class="fas fa-info-circle text-blue-600 mr-2" aria-hidden="true"></i>
                    Detection Technology
                </h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-3">Ensemble ML Models</h4>
                        <ul class="space-y-2 text-gray-700">
                            <li><i class="fas fa-check text-green-500 mr-2"></i>SVM Classifier (94.01% accuracy)</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>CNN Bytecode Analysis (98.65% accuracy)
                            </li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>GRU Sequence Analysis (98.2% accuracy)
                            </li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Logistic Regression (93.97% accuracy)
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-3">Security Analysis Features</h4>
                        <ul class="space-y-2 text-gray-700">
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Permission-based Analysis (112 optimized
                                features)</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Certificate Validation</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Banking Trojan Detection</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Behavioral Pattern Recognition</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Details Modal -->
    <dialog id="detailsModal" class="rounded-xl p-0 w-full max-w-xl">
        <form method="dialog" class="bg-white rounded-xl overflow-hidden">
            <div class="px-5 py-4 border-b flex items-center justify-between">
                <h4 class="font-semibold">Scan Details</h4>
                <button class="text-gray-500 hover:text-gray-700" aria-label="Close"><i
                        class="fas fa-xmark"></i></button>
            </div>
            <div class="p-5">
                <pre id="detailsPre" class="text-xs whitespace-pre-wrap"></pre>
            </div>
            <div class="px-5 py-3 bg-gray-50 text-right">
                <button class="px-3 py-1.5 rounded bg-gray-800 text-white">Close</button>
            </div>
        </form>
    </dialog>

    <!-- App Script -->
    <script type="module">
        // ========= Utilities =========
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => Array.from(document.querySelectorAll(sel));

        const fmt = new Intl.DateTimeFormat(undefined, { dateStyle: 'medium', timeStyle: 'short' });

        const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

        const toHex = (buf) => Array.from(new Uint8Array(buf)).map((b) => b.toString(16).padStart(2, '0')).join('');

        function toast(msg, type = 'info') {
            const root = document.getElementById('toastRoot');
            const el = document.createElement('div');
            el.className = `pointer-events-auto rounded-lg shadow px-4 py-2 text-sm text-white ${type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-gray-900'
                }`;
            el.textContent = msg;
            root.appendChild(el);
            setTimeout(() => el.remove(), 2800);
        }

        async function sha256(file) {
            const arr = new Uint8Array(await file.arrayBuffer());
            const hash = await crypto.subtle.digest('SHA-256', arr);
            return toHex(hash);
        }

        async function isZipApk(file) {
            // APK is a ZIP: magic bytes 0x50 0x4B 0x03 0x04 at start
            const head = new Uint8Array(await file.slice(0, 4).arrayBuffer());
            return head[0] === 0x50 && head[1] === 0x4b;
        }

        function bytes(n) {
            if (n < 1024) return `${n} B`;
            if (n < 1024 * 1024) return `${(n / 1024).toFixed(1)} KB`;
            return `${(n / (1024 * 1024)).toFixed(2)} MB`;
        }

        // ========= State =========
        let scanHistory = [];
        let currentAnalysis = null;
        let charts = {};
        let cancelToken = { cancelled: false };

        const STORAGE_KEY = 'apkScanHistoryV2';

        const threatColors = {
            LOW: 'from-green-500 to-green-600',
            MEDIUM: 'from-yellow-500 to-yellow-600',
            HIGH: 'from-red-500 to-red-600',
        };

        // ========= DOM Elements =========
        const els = {
            singleUpload: document.getElementById('singleUpload'),
            singleFileInput: document.getElementById('singleFileInput'),
            batchUpload: document.getElementById('batchUpload'),
            batchFileInput: document.getElementById('batchFileInput'),
            progressSection: document.getElementById('progressSection'),
            resultsSection: document.getElementById('resultsSection'),
            stagesList: document.getElementById('stagesList'),
            overallProgress: document.getElementById('overallProgress'),
            exportBtn: document.getElementById('exportBtn'),
            resetBtn: document.getElementById('resetBtn'),
            cancelBtn: document.getElementById('cancelBtn'),
            threatLevel: document.getElementById('threatLevel'),
            malwareProbability: document.getElementById('malwareProbability'),
            securityScore: document.getElementById('securityScore'),
            analysisTime: document.getElementById('analysisTime'),
            historyTableBody: document.getElementById('historyTableBody'),
            scannedCount: document.getElementById('scannedCount'),
            securityIssues: document.getElementById('securityIssues'),
            securityFeatures: document.getElementById('securityFeatures'),
            modelScoresChart: document.getElementById('modelScoresChart'),
            securityBreakdownChart: document.getElementById('securityBreakdownChart'),
            permissionAnalysisChart: document.getElementById('permissionAnalysisChart'),
            threatCard: document.getElementById('threatCard'),
            fileMeta: document.getElementById('fileMeta'),
            detailsModal: document.getElementById('detailsModal'),
            detailsPre: document.getElementById('detailsPre'),
            themeToggle: document.getElementById('themeToggle'),
        };

        // ========= Theme =========
        const THEME_KEY = 'apkAnalyzerTheme';
        function applyTheme(mode) {
            document.documentElement.classList.toggle('dark', mode === 'dark');
            document.body.classList.toggle('bg-gray-900', mode === 'dark');
            document.body.classList.toggle('text-gray-100', mode === 'dark');
            els.themeToggle.setAttribute('aria-pressed', String(mode === 'dark'));
        }
        const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
        applyTheme(savedTheme);
        els.themeToggle.addEventListener('click', () => {
            const next = document.documentElement.classList.contains('dark') ? 'light' : 'dark';
            localStorage.setItem(THEME_KEY, next);
            applyTheme(next);
        });

        // ========= Init =========
        document.addEventListener('DOMContentLoaded', () => {
            setupUpload();
            loadScanHistory();
            updateScannedCount();
            els.exportBtn.addEventListener('click', exportZipReport);
            els.resetBtn.addEventListener('click', resetUI);
            els.cancelBtn.addEventListener('click', () => (cancelToken.cancelled = true));
        });

        // ========= Upload Handling =========
        function setupUpload() {
            // Click handlers
            els.singleUpload.addEventListener('click', () => els.singleFileInput.click());
            els.batchUpload.addEventListener('click', () => els.batchFileInput.click());

            // Keyboard support
            [els.singleUpload, els.batchUpload].forEach((el, i) => {
                el.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        (i === 0 ? els.singleFileInput : els.batchFileInput).click();
                    }
                });
            });

            // Change events
            els.singleFileInput.addEventListener('change', (e) => handleSingleFileUpload(e.target.files?.[0]));
            els.batchFileInput.addEventListener('change', (e) => handleBatchFileUpload(Array.from(e.target.files || [])));

            // Drag & drop
            [els.singleUpload, els.batchUpload].forEach((el) => {
                el.addEventListener('dragover', (e) => { e.preventDefault(); el.classList.add('ring-4'); });
                el.addEventListener('dragleave', () => el.classList.remove('ring-4'));
                el.addEventListener('drop', (e) => {
                    e.preventDefault(); el.classList.remove('ring-4');
                    const files = Array.from(e.dataTransfer?.files || []);
                    if (!files.length) return;
                    if (el === els.singleUpload) handleSingleFileUpload(files[0]);
                    else handleBatchFileUpload(files);
                });
            });
        }

        async function handleSingleFileUpload(file) {
            if (!file) return;
            if (!file.name.toLowerCase().endsWith('.apk')) { toast('Please select a .apk file', 'error'); return; }
            if (!(await isZipApk(file))) { toast('File does not look like a valid APK (ZIP).', 'error'); return; }
            if (file.size > 200 * 1024 * 1024) { toast('APK too large (>200MB).', 'error'); return; }
            await analyzeAPK(file);
        }

        async function handleBatchFileUpload(files) {
            const apkFiles = files.filter((f) => f.name.toLowerCase().endsWith('.apk'));
            if (!apkFiles.length) { toast('No valid .apk files selected', 'error'); return; }
            toast(`Starting batch analysis of ${apkFiles.length} files…`);
            for (const file of apkFiles) {
                currentAnalysis = { fileName: file.name, fileSize: file.size, startTime: Date.now(), analysisMode: 'quick' };
                try {
                    const result = await performQuickAnalysis(file);
                    addToHistory(result);
                } catch (e) { console.error(e); }
            }
            updateScannedCount();
            toast('Batch analysis complete', 'success');
        }

        // ========= Analysis =========
        async function analyzeAPK(file) {
            cancelToken = { cancelled: false };
            currentAnalysis = {
                fileName: file.name,
                fileSize: file.size,
                startTime: Date.now(),
                analysisMode: document.querySelector('input[name="analysisMode"]:checked').value,
            };
            showProgressSection();
            hideResultsSection();

            try {
                const analysisResult = await performAnalysis(file, cancelToken);
                if (!analysisResult) return; // cancelled
                showResults(analysisResult);
                addToHistory(analysisResult);
                updateScannedCount();
            } catch (err) {
                console.error('Analysis failed:', err);
                toast('Analysis failed. Please try again.', 'error');
            } finally {
                hideProgressSection();
            }
        }

        async function performAnalysis(file, token) {
            const stages = [
                { name: 'Extracting APK Structure', duration: 400 },
                { name: 'Permission Analysis', duration: 650 },
                { name: 'Certificate Validation', duration: 500 },
                { name: 'Bytecode Pattern Recognition', duration: 900 },
                { name: 'Banking Trojan Detection', duration: 750 },
                { name: 'Behavioral Analysis', duration: 800 },
                { name: 'Ensemble Model Prediction', duration: 600 },
            ];

            els.stagesList.innerHTML = '';
            stages.forEach((s) => {
                const li = document.createElement('li');
                li.className = 'flex items-center space-x-3';
                li.innerHTML = `<div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center"><i class="fas fa-clock text-gray-400 text-xs"></i></div><span class="text-gray-600">${s.name}</span>`;
                els.stagesList.appendChild(li);
            });

            let completed = 0;
            for (let i = 0; i < stages.length; i++) {
                if (token?.cancelled) { toast('Analysis cancelled', 'error'); return null; }
                const stage = stages[i];
                const li = els.stagesList.children[i];
                li.innerHTML = `<div class="w-6 h-6 rounded-full bg-blue-500 flex items-center justify-center"><i class="fas fa-cog fa-spin text-white text-xs"></i></div><span class="text-blue-600 font-medium">${stage.name}</span>`;
                await sleep(stage.duration);
                li.innerHTML = `<div class="w-6 h-6 rounded-full bg-green-500 flex items-center justify-center"><i class="fas fa-check text-white text-xs"></i></div><span class="text-green-600">${stage.name}</span>`;
                completed++;
                els.overallProgress.style.width = `${(completed / stages.length) * 100}%`;
            }

            return generateAnalysisResults(file);
        }

        async function performQuickAnalysis(file) {
            await sleep(100 + Math.random() * 200);
            const suspicious = Math.random() < 0.15;
            const malwareProbability = suspicious ? 60 + Math.random() * 35 : Math.random() * 25;
            const hash = await sha256(file);
            return baseResult(file, 'quick', malwareProbability, Math.round(50 + Math.random() * 100), hash);
        }

        function baseResult(file, mode, malwareProbability, analysisTime, sha256hash) {
            const modelScores = {
                svm: clamp(malwareProbability + jitter(10)),
                cnn: clamp(malwareProbability + jitter(15)),
                gru: clamp(malwareProbability + jitter(12)),
                logistic: clamp(malwareProbability + jitter(8)),
            };
            const permissionIssues = generatePermissionIssues(malwareProbability >= 25);
            const securityFeatures = generateSecurityFeatures();
            return {
                fileName: file.name,
                fileSize: file.size,
                sha256: sha256hash,
                malwareProbability: round2(malwareProbability),
                threatLevel: malwareProbability > 70 ? 'HIGH' : malwareProbability > 40 ? 'MEDIUM' : 'LOW',
                securityScore: Math.max(0, Math.round((100 - malwareProbability) * 0.95)),
                analysisTime: Math.max(1, Math.round(analysisTime)),
                modelScores,
                permissionIssues,
                securityFeatures,
                timestamp: new Date().toISOString(),
                analysisMode: mode,
            };
        }

        function clamp(v) { return Math.max(0, Math.min(100, v)); }
        function jitter(n) { return (Math.random() - 0.5) * n; }
        function round2(n) { return Math.round(n * 100) / 100; }

        function generateAnalysisResults(file) {
            const mode = currentAnalysis.analysisMode;
            let processingTime;
            let baseAcc;
            switch (mode) {
                case 'quick': baseAcc = 93.97; processingTime = 80 + Math.random() * 60; break;
                case 'balanced': baseAcc = 94.01; processingTime = 120 + Math.random() * 120; break;
                default: baseAcc = 99.1; processingTime = 3000 + Math.random() * 2000; break;
            }
            const suspicious = Math.random() < 0.15;
            const isMalware = suspicious && Math.random() < 0.6;
            let malwareProbability;
            if (isMalware) malwareProbability = 75 + Math.random() * 25;
            else if (suspicious) malwareProbability = 25 + Math.random() * 40;
            else malwareProbability = Math.random() * 20;

            return baseResult(file, mode, malwareProbability, processingTime, undefined);
        }

        function generatePermissionIssues(isSuspicious) {
            const issues = [];
            if (isSuspicious) {
                const candidates = [
                    'Requests SYSTEM_ALERT_WINDOW permission (overlay attacks)',
                    'Excessive SMS permissions detected',
                    'Accessibility service binding detected',
                    'Device admin privileges requested',
                    'Suspicious call log access patterns',
                    'Location tracking without clear justification',
                    'Camera access in banking context',
                    'Microphone recording capabilities',
                    'Contact list access detected',
                ];
                const n = 1 + Math.floor(Math.random() * 4);
                while (issues.length < n) {
                    const pick = candidates[Math.floor(Math.random() * candidates.length)];
                    if (!issues.includes(pick)) issues.push(pick);
                }
            }
            return issues;
        }

        function generateSecurityFeatures() {
            const features = [];
            const candidates = [
                'Certificate pinning implemented',
                'Secure communication protocols',
                'Proper signature validation',
                'No hardcoded credentials found',
                'Proper data encryption in storage',
                'No debug information exposed',
                'Anti-tampering mechanisms detected',
                'Secure random number generation',
                'Proper session management',
            ];
            const n = 3 + Math.floor(Math.random() * 4);
            while (features.length < n) {
                const pick = candidates[Math.floor(Math.random() * candidates.length)];
                if (!features.includes(pick)) features.push(pick);
            }
            return features;
        }

        // ========= UI Helpers =========
        function showProgressSection() { els.progressSection.classList.remove('hidden'); }
        function hideProgressSection() { els.progressSection.classList.add('hidden'); }
        function showResultsSection() { els.resultsSection.classList.remove('hidden'); }
        function hideResultsSection() { els.resultsSection.classList.add('hidden'); }

        function setThreatCard(level) {
            els.threatCard.className = `bg-gradient-to-r ${threatColors[level]} text-white p-6 rounded-lg`;
            els.threatLevel.textContent = level;
        }

        function showResults(res) {
            // Summary
            setThreatCard(res.threatLevel);
            els.malwareProbability.textContent = `${res.malwareProbability}%`;
            els.securityScore.textContent = `${res.securityScore}/100`;
            els.analysisTime.textContent = `${res.analysisTime}ms`;

            // File meta
            const fileInfo = [
                `File: <strong>${res.fileName}</strong>`,
                res.sha256 ? `SHA‑256: <code class="break-all">${res.sha256}</code>` : null,
                `Size: ${bytes(res.fileSize || 0)}`,
                `Mode: ${res.analysisMode.toUpperCase()}`,
            ].filter(Boolean).join(' • ');
            els.fileMeta.innerHTML = fileInfo; els.fileMeta.classList.remove('hidden');

            // Lists
            els.securityIssues.innerHTML = res.permissionIssues?.length
                ? res.permissionIssues.map((i) => `<li><i class="fas fa-exclamation-triangle mr-2"></i>${i}</li>`).join('')
                : '<li><i class="fas fa-check mr-2"></i>No security issues detected</li>';
            els.securityFeatures.innerHTML = (res.securityFeatures || []).map((f) => `<li><i class="fas fa-check mr-2"></i>${f}</li>`).join('');

            // Charts
            createCharts(res);
            showResultsSection();
        }

        function createCharts(res) {
            // Destroy existing
            Object.values(charts).forEach((c) => c?.destroy());

            // Model Scores
            charts.model = new Chart(els.modelScoresChart.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['SVM', 'CNN', 'GRU', 'Logistic'],
                    datasets: [{
                        label: 'Malware Probability %',
                        data: [res.modelScores?.svm || 0, res.modelScores?.cnn || 0, res.modelScores?.gru || 0, res.modelScores?.logistic || 0],
                        backgroundColor: ['#3B82F6', '#10B981', '#F59E0B', '#EF4444'],
                        borderRadius: 4,
                    }],
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 } } },
            });

            // Security Breakdown
            const secure = Math.max(0, 100 - res.malwareProbability - 20);
            const warning = Math.min(30, res.malwareProbability < 20 ? 20 : 30);
            const critical = Math.max(0, res.malwareProbability - 70);
            charts.breakdown = new Chart(els.securityBreakdownChart.getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['Secure', 'Warning', 'Critical'], datasets: [{ data: [secure, warning, critical], backgroundColor: ['#10B981', '#F59E0B', '#EF4444'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } },
            });

            // Permission Radar
            const perm = generatePermissionChartData();
            charts.perms = new Chart(els.permissionAnalysisChart.getContext('2d'), {
                type: 'radar',
                data: { labels: perm.labels, datasets: [{ label: 'Risk Level', data: perm.data, backgroundColor: 'rgba(59,130,246,.12)', borderColor: '#3B82F6', borderWidth: 2, pointBackgroundColor: '#3B82F6' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, max: 10 } } },
            });
        }

        function generatePermissionChartData() {
            return { labels: ['SMS', 'Calls', 'Location', 'Camera', 'Microphone', 'Contacts', 'Storage', 'Network'], data: Array(8).fill(0).map(() => Math.floor(Math.random() * 10)) };
        }

        // ========= History =========
        function addToHistory(result) {
            scanHistory.unshift(result);
            if (scanHistory.length > 50) scanHistory = scanHistory.slice(0, 50);
            updateHistoryTable();
            saveScanHistory();
        }

        function updateHistoryTable() {
            els.historyTableBody.innerHTML = scanHistory.slice(0, 10).map((scan) => `
        <tr class="hover:bg-gray-50">
          <td class="px-4 py-3">${scan.fileName}</td>
          <td class="px-4 py-3"><code class="text-xs break-all">${scan.sha256 || '-'}</code></td>
          <td class="px-4 py-3">${fmt.format(new Date(scan.timestamp))}</td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 rounded text-xs font-medium ${scan.threatLevel === 'HIGH' ? 'bg-red-100 text-red-800' : scan.threatLevel === 'MEDIUM' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${scan.threatLevel}</span>
          </td>
          <td class="px-4 py-3">${scan.malwareProbability}%</td>
          <td class="px-4 py-3 space-x-2">
            <button class="text-blue-600 hover:text-blue-800 underline" data-view="${scan.fileName}">View</button>
          </td>
        </tr>
      `).join('');

            // Bind view buttons
            els.historyTableBody.querySelectorAll('button[data-view]').forEach((btn) => {
                btn.addEventListener('click', () => viewScanDetails(btn.getAttribute('data-view')));
            });
        }

        function viewScanDetails(fileName) {
            const scan = scanHistory.find((s) => s.fileName === fileName);
            if (!scan) return;
            els.detailsPre.textContent = JSON.stringify(scan, null, 2);
            els.detailsModal.showModal();
        }

        function loadScanHistory() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            try {
                const parsed = JSON.parse(saved);
                scanHistory = parsed.map((s) => ({ ...s, timestamp: s.timestamp || new Date().toISOString() }));
                updateHistoryTable();
            } catch { /* ignore */ }
        }

        function saveScanHistory() { localStorage.setItem(STORAGE_KEY, JSON.stringify(scanHistory)); }

        function updateScannedCount() { els.scannedCount.textContent = String(scanHistory.length); }

        function resetUI() {
            hideResultsSection();
            els.overallProgress.style.width = '0%';
            els.stagesList.innerHTML = '';
            toast('Reset complete');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ========= Export =========
        async function exportZipReport() {
            if (!scanHistory.length) { toast('No report to export', 'error'); return; }
            const res = scanHistory[0];
            const zip = new JSZip();
            zip.file('report.json', JSON.stringify(res, null, 2));

            // Add chart images if available
            try {
                const addChart = async (chart, name) => {
                    if (!chart) return;
                    const dataUrl = chart.toBase64Image('image/png', 1);
                    const bin = atob(dataUrl.split(',')[1]);
                    const u8 = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
                    zip.file(name, u8, { binary: true });
                };
                await addChart(charts.model, 'model-scores.png');
                await addChart(charts.breakdown, 'security-breakdown.png');
                await addChart(charts.perms, 'permission-radar.png');
            } catch { /* ignore */ }

            const blob = await zip.generateAsync({ type: 'blob' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const base = res.fileName.replace(/\.apk$/i, '');
            a.download = `security-report-${base}-${Date.now()}.zip`;
            a.click();
            URL.revokeObjectURL(url);
            toast('ZIP report downloaded', 'success');
        }
    </script>
</body>

</html>
